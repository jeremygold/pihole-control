<!DOCTYPE html>
<html>
		<head>
				<title>Pihole Control</title>
				<link rel="stylesheet" href="https://bootswatch.com/slate/bootstrap.min.css">
				<meta name="viewport" content="user-scalable=no, width=device-width">
				<style type="text/css">
				table { 
						border: 2px solid black; 
				} 
				th, td { 
						padding: 10px; 
				}
				.alert-enabled { 
						background-color: #dff0d8;
						border-color: #468847;
						color: #468847;
				}
				.alert-disabled { 
						background-color: #f2dede;
						border-color: #b94a48;
						color: #b94a48;
				}
				</style>

				<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
				<script>
					// Initialize Firebase
					var config = {
						apiKey: "AIzaSyD7BweyD6hJYW4NqTULbxw0MdyoWg6jftg",
						authDomain: "pihole-control.firebaseapp.com",
						databaseURL: "https://pihole-control.firebaseio.com",
						projectId: "pihole-control",
						storageBucket: "pihole-control.appspot.com",
						messagingSenderId: "210194800964"
					};
					firebase.initializeApp(config);
				</script>

        <!-- update the version number as needed -->
        <script defer src="/__/firebase/4.1.3/firebase-app.js"></script>
        <!-- include only the Firebase features as you need -->
        <script defer src="/__/firebase/4.1.3/firebase-auth.js"></script>
        <script defer src="/__/firebase/4.1.3/firebase-database.js"></script>
        <!-- initialize the SDK after all desired features are loaded -->
        <script defer src="/__/firebase/init.js"></script>

				<script type="text/javascript">

var handleSignedInUser = function(user) {
    console.log("Handling signed in user " + user.email);
    document.getElementById('user-signed-in').style.display = 'block';
    document.getElementById('user-signed-out').style.display = 'none';
    document.getElementById('email').textContent = user.email;
    addDatabaseCallback();
};

var handleSignedOutUser = function() {
    console.log("Handling signed out user");
    document.getElementById('user-signed-in').style.display = 'none';
    document.getElementById('user-signed-out').style.display = 'block';
};

function setStatus(status) {
    console.log("Status = " + JSON.stringify(status));
    document.getElementById('status').innerHTML = "STATUS: " + status.toUpperCase();
    var statusAlert = document.getElementById('status-alert');
    if(status === "Enabled") {
        statusAlert.classList.add('alert-enabled');
        statusAlert.classList.remove('alert-disabled');
    } else {
        statusAlert.classList.add('alert-disabled');
        statusAlert.classList.remove('alert-enabled');
    }
}

const disable = _ => changeStatus("Disabled");
const enable = _ => changeStatus("Enabled");

// const initStatus = _ => fetch("/status").then(response => { response.text().then(setStatus); });

const stateRef = 'pihole-state';

function changeStatus(newStatus) {
    firebase.database().ref(stateRef).set({stat: newStatus}).then(_ => {
        console.log("Updated database to " + newStatus)
    }).catch(e => {
        console.log("Error updating database: " + e);
    });
}

function addButtonListeners() {
    document.getElementById('sign-out').addEventListener('click', function() {
        console.log("Signing out");
        firebase.auth().signOut().then(_ => {
            handleSignedOutUser();
        }).catch(_ => {
            console.log("Failed to sign out");
        });
    });

    document.getElementById('sign-in').addEventListener('click', function() {
        console.log("Signing in");
        var provider = new firebase.auth.GoogleAuthProvider();

        firebase.auth().signInWithPopup(provider).then(_ => {
            handleSignedInUser(result.user);
        }).catch(function(error) {
            // Handle Errors here.
            console.log("Failed to log in " + error.email);
        });
    });
}

function addAuthStateHandler() {
    firebase.auth().onAuthStateChanged(function(user) {
        console.log("AuthStateChanged");
        window.user = user;

        if(user != undefined) {
            handleSignedInUser(user);
        } else {
            handleSignedOutUser();
        }
    });
}

function addDatabaseCallback() {
    firebase.database().ref(stateRef).on('value', function(snapshot) {
        console.log("Dbase change detected - updating status");
        setStatus(snapshot.val().stat);
    });
}

function queryDatabaseStatus() {
    firebase.database().ref(stateRef).once('value').then(snapshot => {
        console.log("Current Status is " + snapshot.val().stat);
        setStatus(snapshot.val().stat);
    });
}

function initFirebaseSdk() {
    try {
        let app = firebase.app();
        let features = ['auth', 'database', 'messaging', 'storage'].filter(feature => typeof app[feature] === 'function');
        document.getElementById('load').innerHTML = `Firebase SDK loaded with ${features.join(', ')}`;

    } catch (e) {
        console.error(e);
        document.getElementById('load').innerHTML = 'Error loading the Firebase SDK, check the console.';
    }
}

const disable = _ => fetch("/control/disable").then(response => response.text()).then(setStatus);
const enable = _ => fetch("/control/enable").then(response => response.text()).then(setStatus);
const initialize = _ => fetch("/status").then(response => response.text()).then(setStatus);

function initialize() {
    addButtonListeners();
    addAuthStateHandler();
    initFirebaseSdk();
    queryDatabaseStatus();
}

document.addEventListener('DOMContentLoaded', _ => initialize());

        </script>

    </head>
    <body>
        <div class="jumbotron">
            <h1 align="center">Pihole Control</h1>
            <table align="center" style="width:90%;">
                <tr>
                    <td>
                        <button class="btn btn-primary btn-lg" type="button" style="width:100%;" onclick="enable();">ENABLE PIHOLE</button>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button class="btn btn-primary btn-lg" type="button" style="width:100%;" onclick="disable();">DISABLE PIHOLE</button>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="container" align="center" style="width:100%;" border="1">
                            <div class="alert alert-enabled" id="status-alert">
                                <h3 id="status">Status</h3>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="load">Firebase status</div>
                    </td>
                </tr>
            </table>
        </div>

        <div id="user-signed-in" style="display: none">
            <h4 id="email"></h4>
            <button id="sign-out">Sign Out</button>
        </div>
        <div id="user-signed-out">
            <h4>You are signed out.</h4>
            <button id="sign-in">Sign In</button>
        </div>

    </body>
</html>
